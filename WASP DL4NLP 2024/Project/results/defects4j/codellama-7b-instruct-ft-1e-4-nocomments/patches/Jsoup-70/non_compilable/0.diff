diff --git a/tmp/773e1259-9825-423c-b070-91a079912519_buggy.java b/tmp/3a59b4f3-b9be-4a43-b486-b010622bfc50_fixed.java
index 6c87721..a9bb678 100644
--- a/tmp/773e1259-9825-423c-b070-91a079912519_buggy.java
+++ b/tmp/3a59b4f3-b9be-4a43-b486-b010622bfc50_fixed.java
@@ -1,11 +1,20 @@
     static boolean preserveWhitespace(Node node) {
-        // looks only at this element and five levels up, to prevent recursion & needless stack searches
         if (node != null && node instanceof Element) {
             Element el = (Element) node;
             if (el.tag.preserveWhitespace())
                 return true;
             else
                 return el.parent() != null && el.parent().tag.preserveWhitespace();
+        } else if ("#text".equals(node.nodeName())) {
+            Node next = node;
+            while (next != null) {
+                if (next instanceof TextNode && ((TextNode) next).isBlank())
+                    break;
+                else if ("code".equals(next.nodeName()) && next.parent().children().eq(0) == next)
+                break;
+                next = next.parent();
+            }
+            return next != null && next.parent() != null && next.parent().tag.preserveWhitespace();
         }
         return false;
     }
\ No newline at end of file
